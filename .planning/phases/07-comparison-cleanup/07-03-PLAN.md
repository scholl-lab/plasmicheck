---
phase: 07-comparison-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - plasmicheck/scripts/plotting/__init__.py
  - plasmicheck/scripts/plotting/matplotlib_backend.py
  - plasmicheck/scripts/plotting/colors.py
  - plasmicheck/scripts/generate_report.py
  - plasmicheck/scripts/generate_summary_reports.py
  - plasmicheck/cli.py
  - plasmicheck/scripts/run_pipeline.py
  - tests/test_matplotlib_backend.py
autonomous: true

must_haves:
  truths:
    - "User can run `--plot-backend matplotlib --static-report` and get PNG plots generated by matplotlib"
    - "Interactive HTML reports always use Plotly.js regardless of --plot-backend"
    - "`--plot-backend matplotlib` without `--static-report` has no effect (static report required for PNGs)"
    - "Matplotlib plots are functionally equivalent to Plotly (same data, chart types, similar colors)"
    - "All single-sample plots supported: score distribution boxplot, score scatter plot"
    - "All summary plots supported: contamination ratio heatmap, contamination ratio boxplot"
    - "No Kaleido dependency required when using matplotlib backend"
  artifacts:
    - path: "plasmicheck/scripts/plotting/__init__.py"
      provides: "Package marker for plotting subpackage"
    - path: "plasmicheck/scripts/plotting/matplotlib_backend.py"
      provides: "Matplotlib plot generation functions matching Plotly chart types"
      contains: "generate_boxplot_matplotlib"
    - path: "plasmicheck/scripts/plotting/colors.py"
      provides: "Shared color constants matching Plotly defaults"
      contains: "PLOTLY_COLORS"
    - path: "plasmicheck/cli.py"
      provides: "--plot-backend CLI flag on pipeline, report, summary_reports subcommands"
      contains: "plot-backend"
    - path: "plasmicheck/scripts/generate_report.py"
      provides: "Matplotlib dispatch when plot_backend='matplotlib' and static_report=True"
      contains: "plot_backend"
    - path: "plasmicheck/scripts/generate_summary_reports.py"
      provides: "Matplotlib dispatch when plot_backend='matplotlib' and static_report=True"
      contains: "plot_backend"
    - path: "tests/test_matplotlib_backend.py"
      provides: "Tests for matplotlib plot generation"
      contains: "test_generate_boxplot_matplotlib"
  key_links:
    - from: "plasmicheck/cli.py"
      to: "plasmicheck/scripts/run_pipeline.py"
      via: "plot_backend parameter passed through CLI -> run_pipeline"
      pattern: "plot_backend"
    - from: "plasmicheck/scripts/generate_report.py"
      to: "plasmicheck/scripts/plotting/matplotlib_backend.py"
      via: "conditional import when plot_backend='matplotlib'"
      pattern: "from.*plotting.*matplotlib_backend import"
    - from: "plasmicheck/scripts/generate_summary_reports.py"
      to: "plasmicheck/scripts/plotting/matplotlib_backend.py"
      via: "conditional import when plot_backend='matplotlib'"
      pattern: "from.*plotting.*matplotlib_backend import"
---

<objective>
Add matplotlib as an alternative static plot backend (ARCH-03), creating the plotting module, wiring through CLI/pipeline, and integrating with report generation scripts.

Purpose: Users who want static PNG reports currently need Kaleido, which has licensing/maintenance concerns. matplotlib is already a core dependency and can generate publication-quality PNGs without Kaleido. The `--plot-backend matplotlib` flag gives users a reliable alternative.

Output: New `plasmicheck/scripts/plotting/` subpackage with matplotlib chart generators, CLI `--plot-backend` flag, report generation dispatch logic, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-comparison-cleanup/07-CONTEXT.md
@.planning/phases/07-comparison-cleanup/07-RESEARCH.md
@.planning/phases/07-comparison-cleanup/07-02-SUMMARY.md
@plasmicheck/scripts/generate_report.py
@plasmicheck/scripts/generate_summary_reports.py
@plasmicheck/cli.py
@plasmicheck/scripts/run_pipeline.py
@plasmicheck/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create matplotlib plotting module</name>
  <files>
    plasmicheck/scripts/plotting/__init__.py
    plasmicheck/scripts/plotting/matplotlib_backend.py
    plasmicheck/scripts/plotting/colors.py
  </files>
  <action>
  Create the `plasmicheck/scripts/plotting/` subpackage:

  1. **Create `plasmicheck/scripts/plotting/__init__.py`** — empty file (package marker).

  2. **Create `plasmicheck/scripts/plotting/colors.py`** with shared color constants:
     ```python
     """Shared color constants matching Plotly default categorical colors."""
     from __future__ import annotations

     # Plotly's default categorical color sequence (plotly.colors.qualitative.Plotly)
     PLOTLY_COLORS: list[str] = ["#636EFA", "#EF553B", "#00CC96", "#AB63FA", "#FFA15A",
                                  "#19D3F3", "#FF6692", "#B6E880", "#FF97FF", "#FECB52"]

     # Category-specific colors for assignment plots
     ASSIGNMENT_COLORS: dict[str, str] = {
         "Plasmid": "#636EFA",
         "Human": "#EF553B",
         "Tied": "#00CC96",
     }

     # Heatmap colors matching Plotly config
     HEATMAP_COLORS: dict[str, str] = {
         "not_contaminated": "lightblue",
         "unclear": "orange",
         "contaminated": "red",
     }
     ```

  3. **Create `plasmicheck/scripts/plotting/matplotlib_backend.py`** with chart generation functions:

     All functions use lazy imports: `import matplotlib.pyplot as plt`, `import seaborn as sns`, `import numpy as np` inside each function body. Use `from __future__ import annotations` and `TYPE_CHECKING` for pd.DataFrame.

     Functions to implement:

     a. **`generate_boxplot_matplotlib(reads_df, output_path, title, width, height)`**: Single-sample score distribution boxplot.
        - Use `sns.set_theme(style="whitegrid")` for clean style
        - Create boxplot of PlasmidScore by AssignedTo using ASSIGNMENT_COLORS
        - Add jittered scatter points (alpha=0.3, size=2) matching Plotly's `points="all"`
        - Title includes total read count
        - Save as PNG with dpi=300, bbox_inches="tight"
        - `plt.close(fig)` to free memory

     b. **`generate_scatter_matplotlib(reads_df, output_path, title, width, height)`**: Single-sample score scatter plot (PlasmidScore vs HumanScore).
        - Color by AssignedTo using ASSIGNMENT_COLORS
        - Add legend
        - Alpha=0.3 for dense data, size=2
        - Title includes total read count
        - Save as PNG with dpi=300

     c. **`generate_heatmap_matplotlib(ratio_data, output_path, threshold, plot_config)`**: Summary contamination ratio heatmap.
        - `ratio_data` is a pivoted DataFrame (Sample x Plasmid)
        - Use `sns.heatmap` with `cmap="viridis"`, `annot=False`, `cbar=False`
        - Match Plotly layout: rotated x-axis labels (45 degrees), tight layout
        - Save as PNG with dpi=300

     d. **`generate_summary_boxplot_matplotlib(boxplot_data, output_path, log_offset, marker_style)`**: Summary contamination ratio boxplot (log scale).
        - Melt the pivoted data, compute log10(value + offset)
        - Create boxplot by Plasmid
        - Height=800px equivalent (~8 inches at 100dpi)
        - Save as PNG with dpi=300

     All functions should:
     - Accept figsize as `(width_px, height_px)` and convert to inches via `(width/100, height/100)`
     - Handle empty DataFrames gracefully (log warning, create minimal placeholder plot)
     - Use `plt.close(fig)` after saving to prevent memory leaks
     - Return `None` (side effect: file written)

     Type annotations: Use `from __future__ import annotations` and `TYPE_CHECKING` guard for pandas imports. Function signatures should use `pd.DataFrame` in type hints.
  </action>
  <verify>
  - `python -c "from plasmicheck.scripts.plotting.colors import PLOTLY_COLORS, ASSIGNMENT_COLORS; print(len(PLOTLY_COLORS))"` prints 10
  - `python -c "from plasmicheck.scripts.plotting.matplotlib_backend import generate_boxplot_matplotlib, generate_scatter_matplotlib, generate_heatmap_matplotlib, generate_summary_boxplot_matplotlib"` succeeds
  - `make lint && make typecheck` passes
  </verify>
  <done>
  - `plasmicheck/scripts/plotting/` package exists with __init__.py, colors.py, matplotlib_backend.py
  - 4 chart generation functions: boxplot, scatter, heatmap, summary boxplot
  - All use Plotly-matching colors from colors.py
  - All use seaborn whitegrid theme and viridis colormap
  - All handle empty DataFrames gracefully
  - All properly close figures after saving
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire matplotlib backend through CLI, pipeline, and report scripts</name>
  <files>
    plasmicheck/cli.py
    plasmicheck/scripts/run_pipeline.py
    plasmicheck/scripts/generate_report.py
    plasmicheck/scripts/generate_summary_reports.py
  </files>
  <action>
  Wire the `--plot-backend` flag from CLI through to report generation:

  1. **Update `plasmicheck/cli.py`**:
     - Add `--plot-backend` to `_report_parser` (shared parent parser, already used by pipeline, report, summary_reports):
       ```python
       _report_parser.add_argument(
           "--plot-backend",
           choices=["plotly", "matplotlib"],
           default="plotly",
           help="Backend for static PNG plot generation (default: plotly/kaleido). "
                "Only applies when --static-report is used.",
       )
       ```
     - In the `pipeline` command handler: pass `plot_backend=args.plot_backend` to `run_pipeline()`
     - In the `report` command handler: pass `plot_backend=args.plot_backend` to `generate_report()`
     - In the `summary_reports` command handler: pass `plot_backend=args.plot_backend` to `generate_summary_reports()`

  2. **Update `plasmicheck/scripts/run_pipeline.py`**:
     - Add `plot_backend: str = "plotly"` parameter to `run_pipeline()` function signature
     - Pass `plot_backend=plot_backend` to the `generate_report()` call in Step 7
     - In the `__main__` block: add `--plot-backend` argument and pass to `run_pipeline()`

  3. **Update `plasmicheck/scripts/generate_report.py`**:
     - Add `plot_backend: str = "plotly"` parameter to `main()` and `generate_plots()`
     - In `generate_plots()`, when `static_report=True`:
       - If `plot_backend == "matplotlib"`:
         - Import from plotting module: `from .plotting.matplotlib_backend import generate_boxplot_matplotlib, generate_scatter_matplotlib`
         - Call `generate_boxplot_matplotlib(reads_df, boxplot_filename_png, ...)` and `generate_scatter_matplotlib(reads_df, scatter_filename_png, ...)`
         - Do NOT import or use kaleido
       - If `plot_backend == "plotly"` (default): existing Kaleido path (unchanged)
     - Pass `plot_backend` through `main()` to `generate_plots()`

  4. **Update `plasmicheck/scripts/generate_summary_reports.py`**:
     - Add `plot_backend: str = "plotly"` parameter to `main()`, `plot_boxplot()`, and `plot_heatmap()`
     - In `plot_boxplot()`, when `static_report=True`:
       - If `plot_backend == "matplotlib"`:
         - Import and call `generate_summary_boxplot_matplotlib(boxplot_data, boxplot_filename_png, ...)`
         - Do NOT use `fig.write_image()`
       - If `plot_backend == "plotly"`: existing Kaleido path (unchanged)
     - In `plot_heatmap()`, when `static_report=True`:
       - If `plot_backend == "matplotlib"`:
         - Import and call `generate_heatmap_matplotlib(ratio_data, heatmap_filename_png, ...)`
       - If `plot_backend == "plotly"`: existing Kaleido path
     - In `main()`, only call `kaleido.start_sync_server()` when `static_report=True AND plot_backend == "plotly"`
     - Pass `plot_backend` to `plot_boxplot()` and `plot_heatmap()`

  Important constraints:
  - Interactive HTML reports ALWAYS use Plotly.js regardless of `--plot-backend` (per CONTEXT decision)
  - `--plot-backend matplotlib` only affects static PNG generation (requires `--static-report`)
  - When `plot_backend == "matplotlib"`, kaleido is NOT imported at all
  - The default is `"plotly"` to maintain backward compatibility
  </action>
  <verify>
  - `make lint && make typecheck` passes
  - `plasmicheck pipeline --help` shows `--plot-backend` flag with choices [plotly, matplotlib]
  - `plasmicheck report --help` shows `--plot-backend` flag
  - `plasmicheck summary_reports --help` shows `--plot-backend` flag
  - `python -c "from plasmicheck.scripts.generate_report import main; import inspect; sig = inspect.signature(main); print('plot_backend' in sig.parameters)"` prints True
  </verify>
  <done>
  - `--plot-backend` flag available on pipeline, report, and summary_reports subcommands
  - Flag flows CLI -> run_pipeline -> generate_report/generate_summary_reports
  - matplotlib backend path uses plotting module (no kaleido import)
  - plotly backend path unchanged (backward compatible)
  - Interactive HTML always uses Plotly.js regardless of plot_backend
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for matplotlib backend and CLI wiring</name>
  <files>tests/test_matplotlib_backend.py</files>
  <action>
  Create `tests/test_matplotlib_backend.py` with comprehensive tests:

  1. **`test_generate_boxplot_matplotlib_creates_png`**: Create a small DataFrame with columns [ReadID, AssignedTo, PlasmidScore, HumanScore] and rows for Plasmid/Human/Tied. Call `generate_boxplot_matplotlib()` with `tmp_path / "box.png"`. Verify the PNG file exists and is non-empty.

  2. **`test_generate_scatter_matplotlib_creates_png`**: Same DataFrame. Call `generate_scatter_matplotlib()`. Verify PNG exists and is non-empty.

  3. **`test_generate_heatmap_matplotlib_creates_png`**: Create a pivoted DataFrame (Sample x Plasmid) with ratio values. Call `generate_heatmap_matplotlib()`. Verify PNG exists and is non-empty.

  4. **`test_generate_summary_boxplot_matplotlib_creates_png`**: Create pivoted DataFrame. Call `generate_summary_boxplot_matplotlib()`. Verify PNG exists.

  5. **`test_matplotlib_colors_match_plotly`**: Verify `ASSIGNMENT_COLORS` has keys "Plasmid", "Human", "Tied" and values are hex strings matching expected Plotly colors.

  6. **`test_empty_dataframe_handled_gracefully`**: Call each matplotlib function with an empty DataFrame. Verify no exception raised (may produce placeholder plot or log warning, but should not crash).

  7. **`test_plot_backend_cli_flag_exists`**: Use subprocess to run `plasmicheck pipeline --help` and verify `--plot-backend` appears in output. Also check `plasmicheck report --help` and `plasmicheck summary_reports --help`.

  8. **`test_plot_backend_default_is_plotly`**: Parse the CLI help output and verify default is "plotly".

  9. **`test_matplotlib_backend_no_kaleido_import`**: Mock `kaleido` module to raise ImportError. Call `generate_plots()` from generate_report.py with `plot_backend="matplotlib"` and `static_report=True`. Verify it succeeds without importing kaleido. (Use `unittest.mock.patch.dict('sys.modules', {'kaleido': None})`.)

  All tests use `pytest.mark.unit` marker. Use `tmp_path` fixture for output paths.

  Note: matplotlib may need `matplotlib.use("Agg")` for headless testing — call this before any matplotlib import in the test file, or set `MPLBACKEND=Agg` environment variable.
  </action>
  <verify>
  - `MPLBACKEND=Agg pytest tests/test_matplotlib_backend.py -v` — all tests pass
  - `make test-fast` passes (all unit tests including new ones)
  - `make lint && make typecheck` passes
  </verify>
  <done>
  - 9 tests covering PNG creation (4 chart types), color constants, empty DataFrame handling, CLI flag presence, default value, and kaleido-free operation
  - All tests pass
  - No regressions in existing tests
  </done>
</task>

</tasks>

<verification>
1. `make ci-check` passes (lint + format + typecheck + test)
2. `python scripts/regression_test.py` passes (if test data available)
3. `plasmicheck pipeline --help | grep plot-backend` shows the flag
4. `python -c "from plasmicheck.scripts.plotting.matplotlib_backend import generate_boxplot_matplotlib"` succeeds
5. `grep -rn "plot_backend" plasmicheck/scripts/generate_report.py plasmicheck/scripts/generate_summary_reports.py` shows matplotlib dispatch
6. `grep -n "kaleido" plasmicheck/scripts/generate_report.py` — kaleido only imported in `plot_backend == "plotly"` branch
</verification>

<success_criteria>
- User can run `--plot-backend matplotlib --static-report` without Kaleido installed (ARCH-03)
- Interactive HTML always uses Plotly.js regardless of --plot-backend
- matplotlib plots are functionally equivalent to Plotly (same data, chart types, similar colors)
- All 4 chart types supported: single-sample boxplot, single-sample scatter, summary heatmap, summary boxplot
- 9+ new tests for matplotlib backend and CLI wiring
- No regressions in existing functionality (default plotly backend unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/07-comparison-cleanup/07-03-SUMMARY.md`
</output>
