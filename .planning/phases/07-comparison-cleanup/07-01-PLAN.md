---
phase: 07-comparison-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plasmicheck/scripts/compare_alignments.py
  - tests/test_compare_alignments.py
autonomous: true

must_haves:
  truths:
    - "BAM comparison uses samtools collate instead of sort -n for name grouping"
    - "Supplementary alignments are explicitly re-sorted within each read group after collate"
    - "If samtools collate fails or is unavailable, pipeline falls back to sort -n with a logged warning"
    - "Collated output written to temp file (not streaming pipe) for debuggability"
    - "Regression tests pass with identical contamination verdicts and ratios"
  artifacts:
    - path: "plasmicheck/scripts/compare_alignments.py"
      provides: "_collate_bam() function with fallback, _resort_supplementary() helper"
      contains: "samtools collate"
    - path: "plasmicheck/scripts/compare_alignments.py"
      provides: "Updated _namesort_bam renamed or replaced by collate"
      contains: "collate"
    - path: "tests/test_compare_alignments.py"
      provides: "Tests for collate, fallback, and supplementary re-sorting"
      contains: "test_collate"
  key_links:
    - from: "plasmicheck/scripts/compare_alignments.py"
      to: "samtools collate"
      via: "subprocess.run in _collate_bam"
      pattern: 'samtools.*collate'
    - from: "plasmicheck/scripts/compare_alignments.py"
      to: "_resort_supplementary"
      via: "called after collate to re-order supplementary reads"
      pattern: "_resort_supplementary"
    - from: "plasmicheck/scripts/compare_alignments.py"
      to: "_namesort_bam"
      via: "fallback path when collate fails"
      pattern: "sort.*-n|_namesort_bam"
---

<objective>
Replace `samtools sort -n` with `samtools collate` for BAM name grouping in compare_alignments.py, with explicit supplementary alignment re-sorting and automatic fallback to sort -n.

Purpose: samtools collate is 30-50% faster than sort -n because it groups reads by name without full lexicographical sorting. This directly reduces BAM comparison time (11% of pipeline for small datasets, larger share for big datasets).

Output: Updated compare_alignments.py with collate-based name grouping, supplementary re-sorting, and fallback logic. Unit tests covering collate, fallback, and re-sorting behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-comparison-cleanup/07-CONTEXT.md
@.planning/phases/07-comparison-cleanup/07-RESEARCH.md
@plasmicheck/scripts/compare_alignments.py
@tests/test_compare_alignments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sort -n with collate in compare_alignments.py</name>
  <files>plasmicheck/scripts/compare_alignments.py</files>
  <action>
  Modify `plasmicheck/scripts/compare_alignments.py` to replace `_namesort_bam` with collate-based name grouping:

  1. **Add `_collate_bam` function** that uses `samtools collate` (standard mode, NOT fast mode `-f`) to group reads by name:
     - Accept `input_bam: str`, `output_bam: str`, `threads: int` parameters (threads defaults to SAMTOOLS_THREADS from config)
     - Use `tempfile.NamedTemporaryFile(prefix="collate_", suffix=".bam", delete=False)` for collate output
     - Run: `samtools collate -@ {threads} -o {tmp_path} {input_bam} {input_bam}.collate_tmp`
     - After collate succeeds, call `_resort_supplementary(tmp_path, output_bam)` to re-order supplementary reads
     - Clean up tmp_path in a finally block using `Path(tmp_path).unlink(missing_ok=True)`
     - On `subprocess.CalledProcessError` or `FileNotFoundError`, log a warning and fall back to `_namesort_bam_fallback`

  2. **Add `_resort_supplementary` function** that re-sorts supplementary alignments within each read group:
     - Use `pysam.AlignmentFile` to read collated BAM and write re-sorted BAM
     - Use `itertools.groupby` with `key=lambda r: r.query_name` (already the pattern in `_iter_reads_by_name`)
     - Within each group, sort reads by: `(r.is_secondary + r.is_supplementary, r.is_secondary and not r.is_supplementary)` — this puts primary first, supplementary second, secondary last
     - Write sorted reads to output BAM

  3. **Rename existing `_namesort_bam` to `_namesort_bam_fallback`** to make its role as fallback clear. Keep the same implementation.

  4. **Add `_name_group_bam` function** as the public interface that tries collate first, then fallback:
     - Try `_collate_bam` first
     - On failure, log warning and call `_namesort_bam_fallback`
     - This is the function called by `compare_alignments()`

  5. **Update `compare_alignments()` function**:
     - Replace the two `_namesort_bam(plasmid_bam, plasmid_ns)` / `_namesort_bam(human_bam, human_ns)` calls with `_name_group_bam(plasmid_bam, plasmid_ns)` / `_name_group_bam(human_bam, human_ns)`
     - Update the log message from "Name-sorting BAMs" to "Grouping BAMs by read name for streaming comparison..."

  6. **Add `import tempfile` and `from pathlib import Path`** to the imports at the top of the file.

  Important: Do NOT use collate fast mode (`-f`) — it filters out supplementary/secondary alignments entirely. Always use standard collate mode to preserve all alignment records.
  </action>
  <verify>
  - `make lint` passes (ruff)
  - `make typecheck` passes (mypy strict)
  - `python -c "from plasmicheck.scripts.compare_alignments import _collate_bam, _resort_supplementary, _name_group_bam, _namesort_bam_fallback"` succeeds
  </verify>
  <done>
  - `_collate_bam` function exists and calls `samtools collate` (not `-f`)
  - `_resort_supplementary` re-orders reads within groups (primary first)
  - `_name_group_bam` tries collate then falls back to sort -n
  - `compare_alignments()` calls `_name_group_bam` instead of `_namesort_bam`
  - All existing tests in `test_compare_alignments.py` still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for collate, fallback, and supplementary re-sorting</name>
  <files>tests/test_compare_alignments.py</files>
  <action>
  Add tests to `tests/test_compare_alignments.py` covering the new collate functionality:

  1. **`test_collate_bam_calls_samtools_collate`**: Mock `subprocess.run` and verify `_collate_bam` calls `samtools collate` with correct arguments (no `-f` flag, uses `-@` for threads, uses `-o` for output). Also mock `_resort_supplementary` to verify it's called after collate.

  2. **`test_collate_bam_fallback_on_error`**: Mock `subprocess.run` to raise `subprocess.CalledProcessError`. Verify that `_name_group_bam` falls back to `_namesort_bam_fallback` (mock it and check it was called). Verify a warning is logged.

  3. **`test_collate_bam_fallback_on_missing_samtools`**: Mock `subprocess.run` to raise `FileNotFoundError`. Verify fallback path is taken.

  4. **`test_resort_supplementary_ordering`**: Create a small in-memory BAM with pysam containing reads of the same query name but in wrong order (secondary first, then primary, then supplementary). Write to a temp file, call `_resort_supplementary`, read the output, and verify ordering is: primary, supplementary, secondary.

  5. **`test_name_group_bam_uses_collate_by_default`**: Mock `_collate_bam` to succeed. Verify `_name_group_bam` calls `_collate_bam` and does NOT call `_namesort_bam_fallback`.

  6. **`test_collate_temp_file_cleanup`**: Mock subprocess.run to succeed for collate. Verify that the temp file created by `_collate_bam` is cleaned up (not left on disk) after successful execution. Use `tmp_path` fixture.

  Use `pytest.mark.unit` marker for all tests. Use `unittest.mock.patch` for mocking subprocess calls. Use `tmp_path` fixture for any file-based tests.
  </action>
  <verify>
  - `make test-fast` passes (all unit tests including new ones)
  - `pytest tests/test_compare_alignments.py -v` shows all new test_collate* and test_resort* tests passing
  - `make lint && make typecheck` passes
  </verify>
  <done>
  - 6 new tests covering collate call, fallback on CalledProcessError, fallback on FileNotFoundError, supplementary re-ordering, default collate usage, and temp file cleanup
  - All tests pass with `pytest tests/test_compare_alignments.py -v`
  - No regressions in existing compare_alignments tests
  </done>
</task>

</tasks>

<verification>
1. `make ci-check` passes (lint + format + typecheck + test)
2. `python scripts/regression_test.py` passes (if test data available) — contamination verdicts and ratios unchanged
3. `grep -n "samtools collate" plasmicheck/scripts/compare_alignments.py` shows collate usage
4. `grep -n "_resort_supplementary" plasmicheck/scripts/compare_alignments.py` shows re-sorting logic
5. `grep -n "fallback" plasmicheck/scripts/compare_alignments.py` shows fallback to sort -n
</verification>

<success_criteria>
- BAM name grouping uses `samtools collate` instead of `sort -n` (COMP-01)
- Supplementary alignments explicitly re-sorted within each read group (COMP-02)
- Automatic fallback to `sort -n` if collate fails, with logged warning
- Temp file written for debuggability, cleaned up after use
- All existing tests pass, 6+ new tests for collate behavior
</success_criteria>

<output>
After completion, create `.planning/phases/07-comparison-cleanup/07-01-SUMMARY.md`
</output>
