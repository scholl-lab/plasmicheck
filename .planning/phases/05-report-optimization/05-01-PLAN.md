---
phase: 05-report-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plasmicheck/cli.py
  - plasmicheck/scripts/run_pipeline.py
autonomous: true

must_haves:
  truths:
    - "pipeline subcommand accepts --static-report flag"
    - "pipeline subcommand accepts --plotly-mode {cdn,directory,embedded} flag"
    - "report subcommand accepts --static-report and --plotly-mode flags"
    - "summary_reports subcommand accepts --static-report and --plotly-mode flags"
    - "run_pipeline passes static_report and plotly_mode to generate_report"
  artifacts:
    - path: "plasmicheck/cli.py"
      provides: "CLI flag definitions for --static-report and --plotly-mode on pipeline, report, summary_reports"
      contains: "static.report"
    - path: "plasmicheck/scripts/run_pipeline.py"
      provides: "Flag pass-through from pipeline to generate_report"
      contains: "static_report"
  key_links:
    - from: "plasmicheck/cli.py"
      to: "plasmicheck/scripts/run_pipeline.py"
      via: "args.static_report and args.plotly_mode passed to run_pipeline()"
      pattern: "static_report.*plotly_mode"
    - from: "plasmicheck/scripts/run_pipeline.py"
      to: "plasmicheck/scripts/generate_report.py"
      via: "generate_report() call with static_report and plotly_mode kwargs"
      pattern: "generate_report.*static_report"
---

<objective>
Add --static-report and --plotly-mode CLI flags to all report-generating subcommands (pipeline, report, summary_reports) and wire them through the pipeline to the report generation functions.

Purpose: These flags are the foundation for all other Phase 5 work. The generate_report and generate_summary_reports modules need these parameters to implement conditional PNG export and plotly.js mode selection.

Output: Updated cli.py with new flags on three subcommands, updated run_pipeline.py that accepts and forwards the new parameters.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-report-optimization/05-CONTEXT.md
@.planning/phases/05-report-optimization/05-RESEARCH.md

Source files:
@plasmicheck/cli.py
@plasmicheck/scripts/run_pipeline.py
@plasmicheck/scripts/generate_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --static-report and --plotly-mode flags to CLI subcommands</name>
  <files>plasmicheck/cli.py</files>
  <action>
Add two new CLI flags to three subcommands (pipeline, report, summary_reports):

1. Create a shared parent parser `_report_parser` (like the existing `_logging_parser` and `_threshold_parser` patterns):
   ```python
   _report_parser = argparse.ArgumentParser(add_help=False)
   _report_parser.add_argument(
       '--static-report',
       action='store_true',
       help='Generate static PNG reports alongside interactive HTML (opt-in, slower)',
   )
   _report_parser.add_argument(
       '--plotly-mode',
       choices=['cdn', 'directory', 'embedded'],
       default='directory',
       help='Plotly.js inclusion mode for interactive reports (default: directory)',
   )
   ```

2. Add `_report_parser` as a parent to these three subparsers:
   - `parser_pipeline` (add to existing parents list)
   - `parser_report` (add to existing parents list)
   - `parser_summary_reports` (add to existing parents list)

3. Update the `pipeline` command handler (the `elif args.command == "pipeline":` block) to pass the new flags to `run_pipeline()`:
   ```python
   run_pipeline(
       ...existing args...,
       static_report=args.static_report,
       plotly_mode=args.plotly_mode,
   )
   ```

4. Update the `report` command handler to pass new flags to `generate_report()`:
   ```python
   generate_report(
       ...existing args...,
       static_report=args.static_report,
       plotly_mode=args.plotly_mode,
   )
   ```

5. Update the `summary_reports` command handler to pass new flags to `generate_summary_reports()`:
   ```python
   generate_summary_reports(
       ...existing args...,
       static_report=args.static_report,
       plotly_mode=args.plotly_mode,
   )
   ```

IMPORTANT: Use `action='store_true'` for --static-report (NOT `type=bool`). Use `choices=[...]` for --plotly-mode. These match the argparse best practices from the research doc.

NOTE: The downstream functions (generate_report, generate_summary_reports, run_pipeline) do NOT yet accept these parameters. That's fine — we're adding the parameters to the function signatures in this task (run_pipeline.py) and the next plans (generate_report.py, generate_summary_reports.py). For now, generate_report.main() and generate_summary_reports.main() will raise TypeError if called with the new kwargs. This is expected and will be resolved in Plans 02 and 03.
  </action>
  <verify>
Run `python -m plasmicheck.cli pipeline --help` and confirm --static-report and --plotly-mode appear in output.
Run `python -m plasmicheck.cli report --help` and confirm same.
Run `python -m plasmicheck.cli summary_reports --help` and confirm same.
Run `make lint` to check for ruff errors.
Run `make typecheck` to check for mypy errors (there may be expected errors from generate_report/generate_summary_reports not yet accepting the new params — note these but don't fix them, Plans 02/03 will).
  </verify>
  <done>
All three subcommands (pipeline, report, summary_reports) show --static-report and --plotly-mode in their --help output. Flags use correct argparse patterns (store_true, choices).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire flags through run_pipeline to generate_report</name>
  <files>plasmicheck/scripts/run_pipeline.py</files>
  <action>
Update run_pipeline.py to accept and forward the new report flags:

1. Add `static_report` and `plotly_mode` parameters to `run_pipeline()` function signature:
   ```python
   def run_pipeline(
       ...existing params...,
       static_report: bool = False,
       plotly_mode: str = "directory",
   ) -> None:
   ```

2. In the pipeline execution section (Step 7: Generate report, around line 575), pass the new flags to the `generate_report()` call:
   ```python
   generate_report(
       reads_assignment_file,
       summary_file,
       output_subfolder,
       threshold=threshold,
       human_fasta=human_fasta,
       plasmid_gb=plasmid_file,
       sequencing_file=sequencing_file,
       command_line=command_line,
       static_report=static_report,
       plotly_mode=plotly_mode,
   )
   ```

3. Also update the `__main__` block's argparse section at the bottom of run_pipeline.py to include the same two flags (so the script can be run standalone). Add:
   ```python
   parser.add_argument('--static-report', action='store_true', help='Generate static PNG reports')
   parser.add_argument('--plotly-mode', choices=['cdn', 'directory', 'embedded'], default='directory', help='Plotly.js inclusion mode')
   ```
   And pass them in the `run_pipeline()` call at the bottom:
   ```python
   run_pipeline(
       ...existing args...,
       static_report=args.static_report,
       plotly_mode=args.plotly_mode,
   )
   ```

4. Do NOT change the import of `generate_report` at the top of run_pipeline.py. The function signature change for generate_report.main() will happen in Plan 02.

NOTE: After this task, `run_pipeline()` accepts the new flags and passes them through. However, `generate_report.main()` doesn't accept them yet, so a full pipeline run would fail. This is expected — Plans 02 and 03 complete the wiring.
  </action>
  <verify>
Run `make lint` — no new ruff errors.
Run `make typecheck` — check for mypy errors. There may be expected errors about generate_report.main() not accepting static_report/plotly_mode kwargs. Note these but they're expected.
Run `python -c "from plasmicheck.scripts.run_pipeline import run_pipeline; import inspect; sig = inspect.signature(run_pipeline); print(sig)"` to confirm new parameters are in the signature.
  </verify>
  <done>
run_pipeline() function signature includes static_report: bool = False and plotly_mode: str = "directory". These values are forwarded to the generate_report() call inside the pipeline loop. The __main__ block also includes the new flags.
  </done>
</task>

</tasks>

<verification>
1. `python -m plasmicheck.cli pipeline --help` shows --static-report and --plotly-mode flags
2. `python -m plasmicheck.cli report --help` shows --static-report and --plotly-mode flags
3. `python -m plasmicheck.cli summary_reports --help` shows --static-report and --plotly-mode flags
4. `make lint` passes (no new ruff errors)
5. run_pipeline() signature includes the new parameters
</verification>

<success_criteria>
- All three report-generating subcommands accept --static-report (store_true) and --plotly-mode (choices: cdn, directory, embedded; default: directory)
- run_pipeline() forwards both flags to generate_report() call
- Shared _report_parser avoids flag definition duplication
- Existing tests still pass (make test-fast)
</success_criteria>

<output>
After completion, create `.planning/phases/05-report-optimization/05-01-SUMMARY.md`
</output>
