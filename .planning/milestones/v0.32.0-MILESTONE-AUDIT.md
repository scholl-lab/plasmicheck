---
milestone: v0.32.0
audited: 2026-02-14T23:45:00Z
status: passed
scores:
  requirements: 17/18
  phases: 4/4
  integration: 15/15
  flows: 5/5
dropped:
  - TEST-03 (air-gapped Docker test — user decision)
tech_debt:
  - phase: 07-comparison-cleanup
    items:
      - "Phase 7 VERIFICATION.md references collate as active — stale after revert commit a297dbc"
      - "ROADMAP success criterion 1 (30-50% speedup from collate) no longer applicable after revert"
  - phase: 05-report-optimization
    items:
      - "Success criteria 1-2 (runtime benchmarks) verified structurally, not by actual benchmark run"
---

# v0.32.0 Milestone Audit

**Milestone:** v0.32.0 Performance Optimization
**Audited:** 2026-02-14T23:45:00Z
**Status:** PASSED
**Branch:** `feat/phase3-v0.31.0`

## Summary

All 17 active requirements satisfied across 4 phases. Cross-phase integration verified with 15/15 connections wired and 5/5 E2E flows passing. No critical gaps. Minor tech debt (stale documentation after collate revert).

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| TEST-01: Regression test suite | Phase 4 | ✓ Satisfied | regression_test.py (401 lines), --generate and compare modes |
| TEST-02: Performance benchmark | Phase 4 | ✓ Satisfied | benchmark.py (471 lines), per-step timing with statistics |
| TEST-03: Air-gapped Docker test | Phase 5 | DROPPED | User decision — not blocking |
| REPT-01: Default pipeline skips PNG | Phase 5 | ✓ Satisfied | No --static-report → no write_image() calls |
| REPT-02: --static-report opt-in flag | Phase 5 | ✓ Satisfied | Flag on pipeline, report, summary_reports |
| REPT-03: Shared plotly.min.js (directory mode) | Phase 5 | ✓ Satisfied | _ensure_plotly_assets() copies to output/assets/ |
| REPT-04: --plotly-mode cli flag | Phase 5 | ✓ Satisfied | cdn, directory, embedded modes implemented |
| REPT-05: Kaleido start_sync_server() | Phase 5 | ✓ Satisfied | Called once before write_image() in both report scripts |
| REPT-06: Lazy-loaded imports | Phase 5 | ✓ Satisfied | pandas, plotly, jinja2, numpy, scipy, statsmodels at function level |
| ALGN-01: Sequential alignment with full threads | Phase 6 | ✓ Satisfied | No ThreadPoolExecutor, sequential align_reads calls |
| ALGN-02: CPU auto-detection (cgroup/SLURM) | Phase 6 | ✓ Satisfied | 5-tier detection chain in thread_config.py |
| ALGN-03: --threads CLI override | Phase 6 | ✓ Satisfied | Flag on pipeline subcommand, logged as 'CLI --threads=N' |
| ALGN-04: samtools sort -m 2G | Phase 6 | ✓ Satisfied | All 3 sort branches use -m flag, default "2G" from config |
| COMP-01: BAM name grouping benchmarked | Phase 7 | ✓ Satisfied | Collate tested (28-64x slower), sort -n retained |
| COMP-02: Supplementary ordering validated | Phase 7 | ✓ Satisfied | sort -n preserves correct ordering |
| ARCH-01: Human indexing hoisted from loop | Phase 7 | ✓ Satisfied | Upfront indexing phase at run_pipeline.py lines 497-506 |
| ARCH-02: PipelinePlan tracks built indexes | Phase 7 | ✓ Satisfied | built_indexes: set[str] field, checked before index creation |
| ARCH-03: Matplotlib static plot backend | Phase 7 | ✓ Satisfied | --plot-backend matplotlib works without Kaleido |

**Score: 17/18 requirements satisfied (1 dropped)**

## Phase Verification Summary

| Phase | Status | Score | Requirements | Tests Added |
|-------|--------|-------|--------------|-------------|
| 4 - Foundation | PASSED | 11/11 | TEST-01, TEST-02 | regression_test.py, benchmark.py |
| 5 - Report Optimization | PASSED | 20/20 | REPT-01 through REPT-06 | CLI flag tests, lazy import tests |
| 6 - Alignment Optimization | PASSED | 16/16 | ALGN-01 through ALGN-04 | 14 thread_config + 5 CLI tests |
| 7 - Comparison & Cleanup | PASSED | 17/17 | COMP-01, COMP-02, ARCH-01–03 | 6 collate + 8 pipeline + 9 matplotlib |

**All 4 phases PASSED verification.**

## Cross-Phase Integration

### Wiring Verification (15/15)

| Connection | From → To | Status |
|------------|-----------|--------|
| CLI → run_pipeline (static_report) | cli.py → run_pipeline.py | ✓ |
| CLI → run_pipeline (plotly_mode) | cli.py → run_pipeline.py | ✓ |
| CLI → run_pipeline (threads) | cli.py → run_pipeline.py | ✓ |
| CLI → run_pipeline (plot_backend) | cli.py → run_pipeline.py | ✓ |
| run_pipeline → generate_report (static_report, plotly_mode, output_root) | Phase 5 params | ✓ |
| run_pipeline → generate_report (plot_backend) | Phase 7 param | ✓ |
| run_pipeline → generate_summary_reports (all report params) | Phases 5+7 | ✓ |
| run_pipeline → align_reads (minimap2_threads, samtools_threads, sort_memory) | Phase 6 params | ✓ |
| run_pipeline → thread_config (detect_cpu_count, allocate_threads) | Phase 6 detection | ✓ |
| run_pipeline → PipelinePlan.built_indexes | Phase 7 index tracking | ✓ |
| generate_report → matplotlib_backend (conditional dispatch) | Phase 7 backend | ✓ |
| generate_report → Kaleido (conditional import) | Phase 5 optimization | ✓ |
| generate_report → templates (plotly_mode context vars) | Phase 5 templates | ✓ |
| generate_summary_reports → matplotlib_backend | Phase 7 backend | ✓ |
| regression_test.py → run_pipeline (backward compat) | Phase 4 → all | ✓ |

### E2E Flow Verification (5/5)

| Flow | Status | Notes |
|------|--------|-------|
| Default pipeline run | ✓ Verified | Auto-detect threads, no static reports, directory-mode plotly.js |
| Full-featured run (all flags) | ✓ Verified | --static-report --plotly-mode cdn --threads 8 --plot-backend matplotlib |
| Batch run (multi-plasmid) | ✓ Verified | Human index built once, failures don't crash batch |
| Report-only subcommands | ✓ Verified | report and summary_reports accept new flags |
| Regression test compatibility | ✓ Verified | regression_test.py calls run_pipeline with backward-compatible defaults |

### Flag Composition Verification

| Combination | Expected Behavior | Status |
|-------------|-------------------|--------|
| --static-report --plot-backend matplotlib | Matplotlib generates PNGs, Kaleido not imported | ✓ |
| --static-report --plot-backend plotly | Kaleido generates PNGs (original behavior) | ✓ |
| --plot-backend matplotlib (no --static-report) | No effect (static report required for PNGs) | ✓ |
| --plotly-mode cdn | Interactive HTML uses CDN script tag | ✓ |
| --plotly-mode directory | Interactive HTML references shared plotly.min.js | ✓ |
| --plotly-mode embedded | Interactive HTML embeds plotly.js inline (original behavior) | ✓ |
| --threads 8 | Overrides auto-detection, logged as CLI source | ✓ |

## Test Coverage

**Total tests: 170 collected** (up from 125 in v0.31.0)

New tests added by phase:
- Phase 4: regression_test.py + benchmark.py scripts (standalone)
- Phase 5: CLI flag tests, lazy import tests
- Phase 6: 14 thread_config unit tests, 5 CLI integration tests
- Phase 7: 6 collate tests, 8 pipeline tests, 9 matplotlib tests

## Tech Debt

### Phase 7: Stale Documentation After Collate Revert

**Severity:** Low (documentation only, no code impact)

Phase 7 VERIFICATION.md (07-VERIFICATION.md) references samtools collate as the active name-grouping strategy (truths 1-4). However, commit `a297dbc` reverted collate to sort -n after benchmarking showed collate was 28-64x slower on filtered BAMs. The ROADMAP and REQUIREMENTS were updated, but the verification document was not refreshed post-revert.

**Impact:** None on functionality. Documentation inconsistency only.

### Phase 5: Runtime Benchmarks Not Re-validated

**Severity:** Low (structural correctness verified)

Phase 5 success criteria 1-2 (pipeline completion <2s, HTML size 19KB) were verified structurally but not by running actual benchmarks during verification. Phase 6 benchmarks showed 0.577s total on synthetic data (well under 2s target), indirectly validating criterion 1.

**Impact:** None — the Phase 6 benchmark (0.577s synthetic dataset) confirms the performance target was met.

## Performance Highlights

From Phase 6 benchmarking:

| Metric | v0.31.0 | v0.32.0 | Improvement |
|--------|---------|---------|-------------|
| Synthetic dataset (200 reads) | 5.5s | 0.577s | **9.5x faster** |
| Real dataset alignment (APA19-N, 3M reads) | 115.2s | 58.4s | **1.97x faster** |
| Report step (default, no static) | ~11.1s | 0.108s | **~100x faster** |
| CLI startup (lazy imports) | — | -231ms | Measurable reduction |

Key finding: `-m 2G` samtools sort memory delivered largest single improvement (human alignment 65.1s → 13.5s, 4.8x speedup).

## Verdict

**PASSED.** All 17 active requirements satisfied. All 4 phases verified. Cross-phase integration complete (15/15 connections, 5/5 flows). Minor documentation tech debt after collate revert — non-blocking.

---
*Audited: 2026-02-14T23:45:00Z*
*Auditor: Claude (milestone audit orchestrator)*
