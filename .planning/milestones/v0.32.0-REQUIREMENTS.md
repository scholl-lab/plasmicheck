# Requirements Archive: v0.32.0 Performance Optimization

**Archived:** 2026-02-14
**Status:** SHIPPED

This is the archived requirements specification for v0.32.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v1 Requirements

Requirements for this milestone. Each maps to roadmap phases.

### Report Optimization

- [x] **REPT-01**: User can run pipeline without generating static PNG reports (default behavior -- no `--static-report` flag)
- [x] **REPT-02**: User can opt into static PNG report generation with `--static-report` CLI flag
- [x] **REPT-03**: Interactive HTML reports use shared `plotly.min.js` file (directory mode) instead of embedding 4.6 MB per plot
- [x] **REPT-04**: User can choose plotly.js inclusion mode via CLI flag (`cdn`, `directory`, `embedded`)
- [x] **REPT-05**: Kaleido uses `start_sync_server()` initialization for faster PNG export when static reports are requested
- [x] **REPT-06**: Report-related imports (pandas, plotly, jinja2) are lazy-loaded inside functions, not at module level

### Alignment Optimization

- [x] **ALGN-01**: Plasmid and human alignments run sequentially with full thread allocation (user override of original concurrent design)
- [x] **ALGN-02**: Pipeline auto-detects CPU count with cgroup/SLURM awareness for thread tuning
- [x] **ALGN-03**: User can override thread count with `--threads` CLI flag
- [x] **ALGN-04**: All `samtools sort` commands use `-m 2G` memory flag for large BAM performance

### Comparison Optimization

- [x] **COMP-01**: BAM name grouping benchmarked (collate tested, sort -n retained -- collate 28-64x slower on post-alignment filtered BAMs)
- [x] **COMP-02**: Supplementary alignment ordering validated (sort -n preserves correct ordering, no explicit re-sort needed)

### Architectural Cleanup

- [x] **ARCH-01**: Human reference indexing hoisted out of combination loop in pipeline
- [x] **ARCH-02**: PipelinePlan tracks which indexes are already built, skipping redundant lock checks
- [x] **ARCH-03**: User can generate static plots via matplotlib backend (`--plot-backend matplotlib`) without Kaleido dependency

### Testing & Validation

- [x] **TEST-01**: Regression test suite verifying optimization outputs match pre-optimization baseline (contamination ratios, read assignments)
- [x] **TEST-02**: Performance benchmark comparing v0.31.0 vs v0.32.0 on synthetic dataset
- [x] ~~**TEST-03**: Air-gapped environment test (Docker with no network) for directory-mode reports~~ (DROPPED per user decision)

## v2 Requirements

Deferred to future milestones. Tracked but not in current roadmap.

### Advanced Performance

- **PERF-01**: Batch Kaleido export with `write_images()` for multiple reports
- **PERF-02**: Parallel report generation across multiple sample-plasmid combinations
- **PERF-03**: `lazy_loader` library integration (requires Python 3.11.9+)

### Extended Report Options

- **RPTE-01**: `--profile` flag showing per-step timing breakdown
- **RPTE-02**: Plotly.js version pinning in directory mode for reproducible reports

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Kaleido v0.2.1 downgrade | Incompatible with Plotly 6.x, security vulnerabilities |
| orca for static export | Deprecated by Plotly team |
| Selenium/Playwright for screenshots | Massive overhead for simple PNG task |
| ProcessPoolExecutor | ThreadPoolExecutor is lighter for subprocess-heavy I/O work |
| Global sort -n removal | Coordinate-sorted BAMs still needed for fetch()-based coverage functions |
| Scientific enhancements (#82, #64, #68, #65) | Deferred to v0.33.0+ milestone |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| TEST-01 | Phase 4 | Complete |
| TEST-02 | Phase 4 | Complete |
| TEST-03 | Phase 5 | Dropped |
| REPT-01 | Phase 5 | Complete |
| REPT-02 | Phase 5 | Complete |
| REPT-03 | Phase 5 | Complete |
| REPT-04 | Phase 5 | Complete |
| REPT-05 | Phase 5 | Complete |
| REPT-06 | Phase 5 | Complete |
| ALGN-01 | Phase 6 | Complete |
| ALGN-02 | Phase 6 | Complete |
| ALGN-03 | Phase 6 | Complete |
| ALGN-04 | Phase 6 | Complete |
| COMP-01 | Phase 7 | Complete |
| COMP-02 | Phase 7 | Complete |
| ARCH-01 | Phase 7 | Complete |
| ARCH-02 | Phase 7 | Complete |
| ARCH-03 | Phase 7 | Complete |

**Coverage:**
- v1 requirements: 18 total
- Shipped: 17 (94%)
- Dropped: 1 (TEST-03)

---

## Milestone Summary

**Shipped:** 17 of 18 v1 requirements
**Adjusted:** COMP-01 changed from "replace sort -n with collate" to "benchmark collate, retain sort -n" after benchmarking showed collate 28-64x slower
**Dropped:** TEST-03 (air-gapped Docker test) -- user decision, not blocking

---
*Archived: 2026-02-14 as part of v0.32.0 milestone completion*
